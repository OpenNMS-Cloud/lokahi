name: 'Test components in Kubernetes cluster'
description: 'This implements external integration test for all components. This is done in kubernetes cluster deployed in the runner.'
inputs:
  dir-location:
    description: 'The dir containing the change.'
    required: true
    default: 'none'

runs:
  using: "composite"
  steps:
    - name: Init
      run: |

        echo "For init - placeholder"

      shell: bash

    - name: Create & Setup Cluster
      run: |

        #source ./local-sample/config-run 
        echo "Domain: " $DOMAIN   

        # Setup localhost DNS
        cat /etc/hosts
        sudo echo "127.0.0.1 $DOMAIN" | sudo tee -a /etc/hosts

        ./install-local.sh

      shell: bash

    - name: Setup & Run Cucumber Tests
      run: |

        kubectl get pods --all-namespaces

        ### Install dependecies
        ##cd platform/
        ##mvn clean install
        ##cd .. 
        #
        ## Cucumber test
        #cd ${{ inputs.dir-location }}
        #mvn clean install
        #HORIZON_STREAM_BASE_URL=https://onmshs/core
	   # 8181
        #KEYCLOAK_BASE_URL=https://onmshs/auth
        #KEYCLOAK_REALM=opennms
        #KEYCLOAK_USERNAME=admin
        #KEYCLOAK_PASSWORD=admin
        #export HORIZON_STREAM_BASE_URL KEYCLOAK_BASE_URL KEYCLOAK_REALM KEYCLOAK_USERNAME KEYCLOAK_PASSWORD
        #PROJECT_VERSION="$(mvn -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive -q org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)"
        #java -jar "external-horizon-stream-it/target/external-horizon-stream-it-${PROJECT_VERSION}.jar"

        ## If fail, exit which kills the ci-cd workflow.
        ##for i in $(jq '.[0].elements[].steps[].result.status' external-it/external-horizon-stream-it/cucumber.reports/cucumber-report.json);do
        ##  if [[ $i != '"passed"' ]];then
        ##    exit;
        ##  fi
        ##done

        kind delete clusters kind

      shell: bash
