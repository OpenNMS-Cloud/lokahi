name: Development Environment

on:
  pull_request:
    branches:
      - 'develop'
    paths:
      - 'Tiltfile'
      - '.tiltignore'
      - 'tilt-helm-values.yaml'
      - '**/pom.xml'
      - '**/package.json'
      - '**/package-lock.json'
      - '**/yarn.lock'
      - '**/Dockerfile'

jobs:
  tilt-ci:
    name: Development Environment Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: maven # the defaults are okay for this workflow

      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'
          cache-dependency-path: ui/yarn.lock

      # FIXME: This is ugly
      - name: Install Tilt & ctlptl
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
          curl -fsSL https://github.com/tilt-dev/ctlptl/releases/download/v$CTLPTL_VERSION/ctlptl.$CTLPTL_VERSION.linux.x86_64.tar.gz | sudo tar -xzv -C /usr/local/bin ctlptl
        shell: bash
        env:
          CTLPTL_VERSION: 0.8.17

      - name: Set up cluster
        run: |
          ctlptl create cluster kind --registry=ctlptl-registry
        shell: bash

      - name: Test Tilt
        run: |
          tilt ci
        shell: bash
