name: release

on:
  push:
    branches:
      - 'release'

# For now, we have put all steps into a single job, this will allow for just
# one vm to run. We use actions to factor out the functionality. If there is a
# requirement to create additional jobs, maybe to run concurrent jobs, then we
# can split them up later.

jobs:
  tag:
    outputs:
      image-tag: ${{ steps.extract-tag.outputs.image-tag }}
    steps:
    - name: init
      id: extract-tag
      run: |
        
        # In case a workflow, using the self-hosted runner, has failed and
        # the kind cluster is still running.
        kind delete clusters kind
        
        TAG=$(echo ${{ github.event.head_commit.message }} | awk '{ print $2 }')
        
        echo "Head commit message: ${{ github.event.head_commit.message }}"
        echo "Extracted tag: $TAG."
        
        # Validate tag format
        # Format of commit message: RELEASE <tag> - <message>
        # Format of tag (change numbers or dev, but leave everything else): 
        #   v0.0.5-dev
        #   v0.0.5
        if [[ $TAG =~ ^v[0-9]+.[0-9]+.([0-9]+-[a-z]+|[0-9]+)$ ]]
        then
          echo "Valid format, proceed with test."
        else
          echo "Tag format is invalid."
          exit 1
        fi

        echo "release-tag=$TAG" >> $GITHUB_OUTPUT
  build-all:
    needs: tag
    runs-on: ubuntu-latest
    uses: ./.github/workflows/develop.yml
    with:
      image-tag: ${{ needs.tag.outputs.image-tag }}
  release:
    needs: [tag, build-all]
    runs-on: self-hosted
    environment: docker-publish-account
    # Enviroment that contains the required secrets.
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        # Is required to call actions.
      
      - name: dockerhub-login
        run: |

          # This and the following steps are put here rather than put into an
          # action because it is only ever called from this workflow.

          # Login to dockerhub. The session doesn't seem to carry across steps,
          # re-test to confirm.
          #docker login -u ${{ secrets.DOCKERHUB_LOGIN }} -p ${{ secrets.DOCKERHUB_PASS }}
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

      - name: publish-image-minion
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Publish minion image
          cd minion/

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-minion:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-minion:latest

          docker push opennms/horizon-stream-minion:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-minion:latest


      - name: publish-image-minion-gateway
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Publish minion-gateway image
          cd minion-gateway/

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-minion-gateway:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-minion-gateway:latest

          docker push opennms/horizon-stream-minion-gateway:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-minion-gateway:latest

      - name: publish-image-core
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Publish core image
          cd platform/

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-core:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-core:latest

          docker push opennms/horizon-stream-core:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-core:latest
      
      - name: publish-image-ui
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-ui:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-ui:latest

          docker push opennms/horizon-stream-ui:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-ui:latest

      - name: publish-image-keycloak-ui
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-keycloak:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-keycloak:latest

          docker push opennms/horizon-stream-keycloak:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-keycloak:latest

      - name: publish-image-grafana
        run: |

          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-grafana:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-grafana:latest

          docker push opennms/horizon-stream-grafana:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-grafana:latest

      - name: publish-image-rest-server
        run: |

          # Login to dockerhub. Probably could remove this, session created in previous step.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Test build images
          docker images

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-rest-server:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-rest-server:latest

          docker push opennms/horizon-stream-rest-server:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-rest-server:latest

      - name: publish-image-inventory
        run: |

          # Login to dockerhub. Probably could remove this, session created in previous step.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Test build images
          docker images

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-inventory:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-inventory:latest

          docker push opennms/horizon-stream-inventory:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-inventory:latest
      
      - name: publish-image-metrics-processor
        run: |

          # Login to dockerhub. Probably could remove this, session created in previous step.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Test build images
          docker images

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-metrics-processor:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-metrics-processor:latest

          docker push opennms/horizon-stream-metrics-processor:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-metrics-processor:latest
      
      - name: publish-image-notifications
        run: |

          # Login to dockerhub. Probably could remove this, session created in previous step.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Test build images
          docker images

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/horizon-stream-notification:${{ needs.tag.outputs.image-tag }} opennms/horizon-stream-notification:latest

          docker push opennms/horizon-stream-notification:${{ needs.tag.outputs.image-tag }}
          docker push opennms/horizon-stream-notification:latest
      
      - name: publish-image-operator
        run: |
          # Login to dockerhub.
          echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_LOGIN }} --password-stdin

          # Tag and save the image as a file to be published. Both release version and latest.
          docker tag opennms/operator:${{ needs.tag.outputs.image-tag }} opennms/operator:latest

          docker push opennms/operator:${{ needs.tag.outputs.image-tag }}
          docker push opennms/operator:latest

      #- name: tag-release-branch
      #  run: |

      #    # The following checkouts the release branch and merges develop into
      #    # it and then tags release.
      #    git fetch
      #    git tag ${{ needs.tag.outputs.image-tag }}
      #    git push origin ${{ needs.tag.outputs.image-tag }}


