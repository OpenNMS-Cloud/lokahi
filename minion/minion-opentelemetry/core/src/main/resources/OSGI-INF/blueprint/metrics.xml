<?xml version="1.0" encoding="utf-8" ?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.osgi.org/xmlns/blueprint/v1.0.0
        https://osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    ">

    <bean id="compositeMetricReader" class="org.opennms.horizon.minion.opentelemetry.core.internal.CompositeMetricReader" />

    <reference-list interface="io.opentelemetry.sdk.metrics.export.MetricReader" availability="optional">
        <reference-listener ref="compositeMetricReader" bind-method="registerReader" unbind-method="unregisterReader" />
    </reference-list>

    <!-- metrics -->
    <bean id="meterProvider" class="org.opennms.horizon.minion.opentelemetry.core.internal.MeterProviderWrapper">
        <argument ref="compositeMetricReader" />
    </bean>
    <service id="managedMeterProvider" ref="meterProvider" auto-export="interfaces" />

    <!-- otel -->
    <bean id="openTelemetry" class="org.opennms.horizon.minion.opentelemetry.core.internal.OpenTelemetryWrapper">
        <argument ref="meterProvider" />
    </bean>
    <bean id="globalOpenTelemetryFactory" class="org.opennms.horizon.minion.opentelemetry.core.internal.GlobalOpenTelemetryPopulator" init-method="initialize" destroy-method="destroy">
        <argument ref="openTelemetry" />
    </bean>
    <service id="managedOpenTelemetry" ref="openTelemetry" auto-export="interfaces" />

</blueprint>
