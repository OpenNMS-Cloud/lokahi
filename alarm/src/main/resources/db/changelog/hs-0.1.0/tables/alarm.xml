<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="jwhite" id="hs-0.1.0-alarm">
        <createTable tableName="alarm">
            <!-- Associated tenant -->
            <column name="tenant_id" type="text" defaultValue="opennms-prime">
                <constraints nullable="false"/>
            </column>

            <!-- Unique identifier -->
            <column name="alarm_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <!-- A reference to the eventUei that created this alarm. -->
            <column name="event_uei" type="text">
                <constraints nullable="false"/>
            </column>

            <column name="reduction_key" type="text"/>

            <column name="type" type="integer"/>

            <column name="counter" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="severity" type="integer">
                <constraints nullable="false"/>
            </column>

            <!-- timestamp of the first event matching this alarm -->
            <column name="first_event_time" type="TIMESTAMP WITH TIME ZONE"/>

            <!-- timestamp of the last event matching this alarm -->
            <column name="last_event_time" type="TIMESTAMP WITH TIME ZONE"/>

            <!-- description from the event -->
            <column name="description" type="text"/>

            <!-- the logmsg from the event -->
            <column name="log_message" type="text"/>

            <!-- user that acknowledged the alarm -->
            <column name="acknowledged_by_user" type="text"/>

            <!-- time user acknowledged the alarm -->
            <column name="acknowledged_at" type="TIMESTAMP WITH TIME ZONE"/>

            <column name="last_event_id" type="bigint"/>

            <!-- the key that will match an event to clear the alarm -->
            <column name="clear_key" type="text"/>

            <column name="managed_object_type" type="integer"/>

            <column name="managed_object_instance" type="text"/>
        </createTable>

        <addPrimaryKey columnNames="tenant_id, alarm_id"
                       constraintName="alarm_pk"
                       tableName="alarm"/>

        <createIndex tableName="alarm" indexName="alarm_reductionkey_idx" unique="true">
            <column name="tenant_id"/>
            <column name="reduction_key"/>
        </createIndex>

        <createSequence sequenceName="alarm_nxt_id"/>
    </changeSet>

    <!-- Conditionally create distributed table if Citus is detected -->
    <changeSet author="jwhite" id="hs-0.1.0-alarm-distributed-table">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="t">SELECT to_regproc('create_distributed_table') IS NOT NULL;</sqlCheck>
        </preConditions>
        <sql>
            SELECT create_distributed_table('alarm', 'tenant_id');
        </sql>
    </changeSet>

</databaseChangeLog>
