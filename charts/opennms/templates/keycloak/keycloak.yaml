apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: {{ .Values.Keycloak.ServiceName }}
  namespace: {{ .Values.Namespace }}
  labels:
    app: keycloak
spec:
  instances: {{ .Values.Keycloak.Replicas }}
  hostname: {{ .Values.Host }}
  tlsSecret: {{ if .Values.TLS.Enabled }}{{ .Values.TLS.Cert.Name }}{{ else }}INSECURE-DISABLE{{ end }}
  image: {{ .Values.Keycloak.Image }}
  disableDefaultIngress: true
  serverConfiguration:
    - name: hostname
      value: {{ .Values.Host }}
    {{ if .Values.Port }}
    - name: hostname-port
      value: "{{ .Values.Port }}"
    {{ end }}
    - name: db
      value: postgres
    - name: db-url-host
      value: {{ .Values.Postgres.ServiceName }}
    - name: http-relative-path
      value: {{ .Values.Keycloak.Path }}
    - name: db-username
      secret:
        name: postgres
        key: keycloakUser
    - name: db-password
      secret:
        name: postgres
        key: keycloakPwd
    - name: hostname-strict
      value: "false"
    - name: hostname-strict-backchannel
      value: "false"
    - name: proxy
      value: passthrough
    - name: http-enabled
      value: 'true'
