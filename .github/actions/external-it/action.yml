name: 'Test components in Kubernetes cluster'
description: 'This implements external integration test for all components. This is done in kubernetes cluster deployed in the runner.'
inputs:
  dir-location:
    description: 'The dir containing the change.'
    required: true
    default: 'none'

runs:
  using: "composite"
  steps:
    - name: Init
      run: |

        echo "For init - placeholder"
        # Confirm versions
        #java --version # JDK 11
        #docker version
        #kubectl -h

      shell: bash

    - name: Create & Setup Cluster
      run: |

        # Test version to get cucumber report values.
        #jq --version
        #kind version
        #kubectl version
        #kubectl get nodes
        #docker ps 
        #docker stats --no-stream

        # Setup localhost DNS
        cat /etc/hosts
        sudo echo "127.0.0.1 localhostcore" | sudo tee -a /etc/hosts
        sudo echo "127.0.0.1 localhostui" | sudo tee -a /etc/hosts
        sudo echo "127.0.0.1 localhostkey" | sudo tee -a /etc/hosts
        sudo echo "127.0.0.1 localhostapi" | sudo tee -a /etc/hosts
        sudo echo "127.0.0.1 localhostkaraf" | sudo tee -a /etc/hosts

        cd local-sample/
        sed -i.bak 's/IMAGE_TAG=latest/IMAGE_TAG=local/g' config-run
        sed -i.bak 's/CI_CD_RUN=false/CI_CD_RUN=true/g' config-run
        ./run.sh

        # List images in kind cluster container.  
        # ISSUE: This produces an error, not required if the '$ kubectl apply
        # -f ...' succeeds below, means image loads were successful.
        #docker exec -it kind-control-plane crictl images ls
 
      shell: bash

    - name: Setup & Run Cucumber Tests
      run: |

        # Test
        echo "test 1"
        kubectl get ingress; pwd

        ## Install dependecies
        #cd platform/
        #mvn clean install
        #cd .. 
        
        # Cucumber test
        cd ${{ inputs.dir-location }}
        mvn clean install
        HORIZON_STREAM_BASE_URL=http://localhostui
        KEYCLOAK_BASE_URL=http://localhostkey
        KEYCLOAK_REALM=opennms
        KEYCLOAK_USERNAME=user001
        KEYCLOAK_PASSWORD=passw0rd
        export HORIZON_STREAM_BASE_URL KEYCLOAK_BASE_URL KEYCLOAK_REALM KEYCLOAK_USERNAME KEYCLOAK_PASSWORD
        PROJECT_VERSION="$(mvn -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive -q org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)"
        java -jar "external-horizon-stream-it/target/external-horizon-stream-it-${PROJECT_VERSION}.jar"

        # If fail, exit which kills the ci-cd workflow.
        #for i in $(jq '.[0].elements[].steps[].result.status' external-it/external-horizon-stream-it/cucumber.reports/cucumber-report.json);do
        #  if [[ $i != '"passed"' ]];then
        #    exit;
        #  fi
        #done

      shell: bash
