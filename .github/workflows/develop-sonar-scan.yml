name: develop-sonar-scan

on: workflow_dispatch

jobs:
  full-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      # This needs to happen before shared-lib.
      - name: 'Build parent-pom'
        id: action-parent-pom
        uses: ./.github/actions/parent-pom
        with:
          dir-location: 'parent-pom'

      # This needs to happen before core, rest-server, and notifications.
      - name: 'Build shared-lib'
        id: action-shared-lib
        uses: ./.github/actions/shared-lib
        with:
          dir-location: 'shared-lib'

      - name: 'Scan shared-lib'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'shared-lib'
          project-key: 'opennms_horizon-stream_shared-lib'

      - name: 'Build core'
        id: action-feature-core
        uses: ./.github/actions/core
        with:
          dir-location: 'platform'

      - name: 'Scan core'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'platform'
          project-key: 'opennms_horizon-stream_core'

      - name: 'Build metrics-processor'
        id: action-feature-metrics-processor
        uses: ./.github/actions/metrics-processor

      - name: 'Scan metrics-processor'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'metrics-processor'
          project-key: 'opennms_horizon-stream_metrics-processor'

      - name: 'Build rest-server'
        id: action-rest-server
        uses: ./.github/actions/rest-server
        with:
          dir-location: 'rest-server'

      - name: 'Scan rest-server'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'rest-server'
          project-key: 'opennms_horizon-stream_rest-server'

      - name: 'Build inventory'
        id: action-inventory
        uses: ./.github/actions/inventory
        with:
          dir-location: 'inventory'

      - name: 'Scan inventory'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'inventory'
          project-key: 'opennms_horizon-stream_inventory'

      - name: 'Build notifications'
        id: action-notifications
        uses: ./.github/actions/notifications
        with:
          dir-location: 'notifications'

      - name: 'Scan notifications'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'notifications'
          project-key: 'opennms_horizon-stream_notifications'

      - name: 'Build minion'
        id: action-minion
        uses: ./.github/actions/minion
        with:
          dir-location: 'minion'

      - name: 'Scan minion'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'minion'
          project-key: 'opennms_horizon-stream_minion'

      - name: 'Build minion-gateway'
        id: action-minion-gateway
        uses: ./.github/actions/minion-gateway
        with:
          dir-location: 'minion-gateway'

      - name: 'Scan minion-gateway'
        uses: ./.github/actions/sonar-scan-maven
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          dir-location: 'minion-gateway'
          project-key: 'opennms_horizon-stream_minion-gateway'
