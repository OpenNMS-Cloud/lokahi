name: develop

on:
  push:
    branches:
      - 'develop'
      - 'jira/HS-293-ci-cd-ipeline-with-operator-changes'
  pull_request:
    #types: [ labeled, closed]
    types: [ labeled]
    branches:
      - 'develop'

# For now, we have put all steps into a single job, this will allow for just
# one vm to run. We use actions to factor out the functionality. If there is a
# requirement to create additional jobs, maybe to run concurrent jobs, then we
# can split them up later.

# Caching - When running multiple jobs in parallel, if they all reference the
# same dir cache, then only one job's files seem to get written. That is why we
# reference the specific files within tmp/.

jobs:
  
  image-wrappers:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
  
      - name: feature-grafana
        id: action-feature-grafana
        uses: ./.github/actions/grafana
        with:
          dir-location: 'grafana'
      - name: grafana-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-grafana-local.tar
          key: grafana-image-cache-${{ env.BRANCH }}-${{ github.actor }}

      - name: feature-keycloak-ui
        id: action-feature-keycloak-ui
        uses: ./.github/actions/keycloak-ui
        with:
          dir-location: 'keycloak-ui'
      - name: keycloak-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-keycloak-local.tar
          key: keycloak-image-cache-${{ env.BRANCH }}-${{ github.actor }}
  
  shared-lib:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Init
        run: echo "BRANCH=$( echo ${{ github.ref }} | sed 's/\//\-/g')" >> $GITHUB_ENV
      - name: shared-lib
        id: action-shared-lib
        uses: ./.github/actions/shared-lib
        with:
          dir-location: 'shared-lib'
      - name: shared-lib-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
          key: shared-lib-${{ env.BRANCH }}-${{ github.actor }}

  feature-ui:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: ui-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-ui-local.tar
          key: ui-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: feature-ui
        id: action-feature-ui
        uses: ./.github/actions/ui
        with:
          dir-location: 'ui'

  feature-operator:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: operator-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/opennms-operator-local.tar
          key: operator-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: feature-operator
        id: action-feature-operator
        uses: ./.github/actions/operator
        with:
          dir-location: 'operator'

  feature-core:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    needs: [ shared-lib ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Init
        run: echo "BRANCH=$( echo ${{ github.ref }} | sed 's/\//\-/g')" >> $GITHUB_ENV
      - name: shared-lib-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
          key: shared-lib-${{ env.BRANCH }}-${{ github.actor }}
      - name: core-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-core-local.tar
          key: core-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: feature-core
        id: action-feature-core
        uses: ./.github/actions/core
        with:
          dir-location: 'platform'

  feature-notifications:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    needs: [ shared-lib ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Init
        run: echo "BRANCH=$( echo ${{ github.ref }} | sed 's/\//\-/g')" >> $GITHUB_ENV && mkdir -p ~/tmp/
      - name: shared-lib-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
          key: shared-lib-${{ env.BRANCH }}-${{ github.actor }}
      - name: notifications-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-notification-local.tar
          key: notifications-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: feature-notifications
        id: action-notifications
        uses: ./.github/actions/notifications
        with:
          dir-location: 'notifications'

  feature-rest-server:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    needs: [ shared-lib ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Init
        run: echo "BRANCH=$( echo ${{ github.ref }} | sed 's/\//\-/g')" >> $GITHUB_ENV && mkdir -p ~/tmp/
      - name: shared-lib-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
          key: shared-lib-${{ env.BRANCH }}-${{ github.actor }}
      - name: rest-server-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-rest-server-local.tar
          key: rest-server-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: feature-rest-server
        id: action-rest-server
        uses: ./.github/actions/rest-server
        with:
          dir-location: 'rest-server'
 
  test-tmp:
    runs-on: ubuntu-latest
    needs: [ feature-rest-server, feature-notifications ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Init
        run: echo "BRANCH=$( echo ${{ github.ref }} | sed 's/\//\-/g')" >> $GITHUB_ENV && mkdir -p ~/tmp/

      # Need multiple of the following, while rest-server was using cache for
      # ~/tmp/ dir, notifications was not getting written to ~/tmp/.

      - name: rest-server-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-rest-server-local.tar
          key: rest-server-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: notifications-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-notification-local.tar
          key: notifications-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: ui-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-ui-local.tar
          key: ui-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: grafana-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-grafana-local.tar
          key: grafana-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: keycloak-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-keycloak-local.tar
          key: keycloak-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: operator-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/opennms-operator-local.tar
          key: operator-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: core-image-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/tmp/opennms-horizon-stream-core-local.tar
          key: core-image-cache-${{ env.BRANCH }}-${{ github.actor }}
      - name: test-tmp
        run: |
          ls -ltah ~/tmp/

  external-it:
    # If label for PR, closed on PR, or develop branch on push, then run., 
    #if: ${{ ( github.event.label.name == 'actions-develop' ) || ( github.event.action == 'closed' ) || ( github.event.ref == 'refs/heads/develop' ) }}
    runs-on: ubuntu-latest
    needs: [ image-wrappers, feature-ui, feature-notifications, feature-operator, feature-core, feature-rest-server ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
    
      - name: test-dependencies
        run: |

          echo "Testing for optimized workflows. EXTERNAL-IT"
          docker images

      # IMPORTANT: Once all images are imported into docker from ~/tmp/, delete
      # ~/tmp/ to get back disk space. Try first, see if we can get Kind to run
      # ok with it.

      #- name: Setup tmate session
      #  uses: mxschmitt/action-tmate@v3

      #- name: feature-operator
      #  id: action-feature-operator
      #  uses: ./.github/actions/operator
      #  with:
      #    dir-location: 'operator'

      #- name: feature-core
      #  id: action-feature-core
      #  uses: ./.github/actions/core
      #  with:
      #    dir-location: 'platform'

      #- name: feature-rest-server
      #  id: action-rest-server
      #  uses: ./.github/actions/rest-server
      #  with:
      #    dir-location: 'rest-server'

      #- name: external-it
      #  id: action-external-it
      #  uses: ./.github/actions/external-it
      #  with:
      #    dir-location: 'external-it'

