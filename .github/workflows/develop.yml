name: develop

on:
  push:
    branches:
      - '**'
#      - 'develop'
#  pull_request:
#    #types: [ labeled, closed]
#    types: [ labeled ]
#    branches:
#      - 'develop'
#  pull_request:
#    branches:
#      - 'develop'

jobs:
  core:
    uses: ./.github/workflows/feature-core.yml
    secrets: inherit
  rest-server:
    uses: ./.github/workflows/feature-rest-server.yml
    secrets: inherit
  inventory:
    uses: ./.github/workflows/feature-inventory.yml
    secrets: inherit
    with:
      image-tag: local
  metrics-processor:
    uses: ./.github/workflows/feature-metrics-processor.yml
    secrets: inherit
  notifications:
    uses: ./.github/workflows/feature-notifications.yml
    secrets: inherit
  minion:
    uses: ./.github/workflows/feature-minion.yml
    secrets: inherit
  minion-gateway:
    uses: ./.github/workflows/feature-minion-gateway.yml
    secrets: inherit
  ui:
    uses: ./.github/workflows/feature-ui.yml
    secrets: inherit
  operator:
    uses: ./.github/workflows/feature-operator.yml
    secrets: inherit
  grafana:
    uses: ./.github/workflows/feature-grafana.yml
    secrets: inherit
  keycloak-ui:
    uses: ./.github/workflows/feature-keycloak-ui.yml
    secrets: inherit
  external-it:
    needs: [
      core,
      rest-server,
      inventory,
      metrics-processor,
      notifications,
      minion,
      minion-gateway,
      ui,
      operator,
      grafana,
      keycloak-ui
    ]
    runs-on: self-hosted
    steps:
      - name: Create & Setup Cluster
        run: |

          # Delete if exists from previous failed run.
          kind delete clusters kind

          # Setup localhost DNS
          sudo echo "127.0.0.1 onmshs" | sudo tee -a /etc/hosts

          # Build cluster with Horizon Stream installed.
          ./install-local.sh custom-images

        shell: bash

      - name: Setup & Run Cucumber Tests
        run: |
          kubectl --context kind-kind -n local-instance port-forward --pod-running-timeout 1s services/opennms-core 11080:8181 &

          # Core takes some time after ready status true before it is setup and
          # has the minion coming in.
          sleep 500

          mvn clean install
          HORIZON_STREAM_BASE_URL=http://localhost:11080
          KEYCLOAK_BASE_URL=https://onmshs/auth
          KEYCLOAK_REALM=opennms
          KEYCLOAK_USERNAME=admin
          KEYCLOAK_PASSWORD=admin
          export HORIZON_STREAM_BASE_URL KEYCLOAK_BASE_URL KEYCLOAK_REALM KEYCLOAK_USERNAME KEYCLOAK_PASSWORD
          PROJECT_VERSION="$(mvn -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive -q org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)"
          java -jar "external-horizon-stream-it/target/external-horizon-stream-it-${PROJECT_VERSION}.jar"

          ## If fail, exit which kills the ci-cd workflow.
          ##for i in $(jq '.[0].elements[].steps[].result.status' external-it/external-horizon-stream-it/cucumber.reports/cucumber-report.json);do
          ##  if [[ $i != '"passed"' ]];then
          ##    exit;
          ##  fi
          ##done

        shell: bash
        working-directory: external-it

      - name: Cleanup
        run: |
          kind delete clusters kind

        shell: bash
