<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0"
           xsi:schemaLocation="
		http://www.osgi.org/xmlns/blueprint/v1.0.0
		http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd

		http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.5.0
		http://aries.apache.org/schemas/blueprint-ext/blueprint-ext-1.5.xsd

		http://camel.apache.org/schema/blueprint
		http://camel.apache.org/schema/blueprint/camel-blueprint-3.15.0.xsd">

    <!-- Load system properties -->
    <ext:property-placeholder />

    <!-- service imports DAOs (services et al) -->
    <reference id="alarmDao" interface="org.opennms.horizon.db.dao.api.AlarmDao" />
    <reference id="sessionUtils" interface="org.opennms.horizon.db.dao.api.SessionUtils" />
    <reference id="eventForwarder" interface="org.opennms.horizon.events.api.EventForwarder" />
    <reference id="eventDao" interface="org.opennms.horizon.db.dao.api.EventDao" />
    <reference id="acknowledgmentDao" interface="org.opennms.horizon.db.dao.api.AcknowledgmentDao" />

    <bean id="alarmEntityNotifier" class="org.opennms.netmgt.alarmd.AlarmEntityNotifierImpl"/>
    <service interface="org.opennms.horizon.alarms.api.AlarmEntityNotifier" ref="alarmEntityNotifier"/>

    <!-- drools integration -->
    <bean id="defaultAlarmService" class="org.opennms.netmgt.alarmd.drools.DefaultAlarmService">
        <property name="acknowledgmentDao" ref="acknowledgmentDao" />
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventForwarder" ref="eventForwarder" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>

    <bean id="defaultAlarmTicketerService" class="org.opennms.netmgt.alarmd.drools.DefaultAlarmTicketerService">
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventForwarder" ref="eventForwarder" />
    </bean>

    <bean id="droolsAlarmContext" class="org.opennms.netmgt.alarmd.drools.DroolsAlarmContext">
        <property name="acknowledgmentDao" ref="acknowledgmentDao" />
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmService" ref="defaultAlarmService" />
        <property name="alarmTicketerService" ref="defaultAlarmTicketerService" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>
    <service id="alarmLifecycleListener" ref="droolsAlarmContext" interface="org.opennms.horizon.alarms.api.AlarmLifecycleListener" />

    <!-- daemon -->
    <bean id="metricRegistry" class="com.codahale.metrics.MetricRegistry" />
    <bean id="alarmPersister" class="org.opennms.netmgt.alarmd.AlarmPersisterImpl">
        <property name="alarmDao" ref="alarmDao" />
        <property name="alarmEntityNotifier" ref="alarmEntityNotifier" />
        <property name="eventDao" ref="eventDao" />
        <property name="sessionUtils" ref="sessionUtils" />
    </bean>

    <reference-list id="alarmPersisterExtensions" interface="org.opennms.horizon.alarms.api.AlarmPersisterExtension" availability="optional" >
        <reference-listener ref="alarmPersister" bind-method="onExtensionRegistered" unbind-method="onExtensionUnregistered" />
    </reference-list>

    <bean id="alarmLifecycleListenerManager" class="org.opennms.netmgt.alarmd.AlarmLifecycleListenerManager" init-method="start" destroy-method="stop" >
        <property name="alarmDao" ref="alarmDao" />
        <property name="sessionUtils" ref="sessionUtils" />
        <property name="listener" ref="droolsAlarmContext" />
    </bean>
    <bean id="daemon" class="org.opennms.netmgt.alarmd.Alarmd" init-method="onStart" destroy-method="onStop">
        <property name="persister" ref="alarmPersister" />
        <property name="droolsAlarmContext" ref="droolsAlarmContext" />
        <property name="alarmLifecycleListenerManager" ref="alarmLifecycleListenerManager" />
    </bean>

    <service interface="org.opennms.horizon.alarms.api.AlarmEntityListener" ref="alarmLifecycleListenerManager"/>
    <reference-list id="alarmLifecycleListeners" interface="org.opennms.horizon.alarms.api.AlarmLifecycleListener" availability="optional">
        <reference-listener ref="alarmLifecycleListenerManager" bind-method="onListenerRegistered" unbind-method="onListenerUnregistered" />
    </reference-list>

    <camelContext autoStartup="true" id="alarmCamelContext" xmlns="http://camel.apache.org/schema/blueprint" allowUseOriginalMessage="false">
        <route id="receiveEvent">
            <from uri="kafka:events?brokers=localhost:9092"/>
            <unmarshal><jaxb contextPath="org.opennms.horizon.events.xml"/></unmarshal>
            <log message="Received Event: ${body}"/>
            <to uri="bean:daemon?method=onEvent"/>
        </route>
    </camelContext>

</blueprint>
