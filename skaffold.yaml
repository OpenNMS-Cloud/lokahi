apiVersion: skaffold/v2beta28
kind: Config
metadata:
  name: horizon-stream
requires:
  - configs: ["operator-dependencies"]
  - configs: ["shared-lib"]
    path: shared-lib/skaffold.yaml
  - configs: ["horizon-stream-ui"]
    path: ui/skaffold.yaml
profiles:
  - name: prod
build:
  artifacts:
  - image: opennms/horizon-stream-core
    context: platform
    custom:
      buildCommand: "mvn install -Pbuild-docker-images-enabled -DskipTests=$SKIP_TEST -Ddocker.image=$IMAGE -Ddocker.skipPush=!$PUSH_IMAGE"
      dependencies:
        paths: ["."]
        ignore: [
          "**/target/**",
          "**/dependency-reduced-pom.xml" # generated by maven-shade-plugin, these cause file watching to break when running `skaffold debug`
        ]
    requires:
      - image: shared_lib
  - image: opennms/horizon-stream-rest-server
    context: rest-server
    jib: {}
    sync:
      auto: true
    requires:
      - image: shared_lib
  - image: opennms/horizon-stream-notification
    context: notifications
    jib: {}
    sync:
      auto: true
    requires:
      - image: shared_lib
  - image: opennms/horizon-stream-keycloak-dev
    context: keycloak-ui
    sync:
      infer:
        - "themes/**"
    docker:
      dockerfile: Dockerfile
  - image: opennms/grafana-dev
    context: grafana
    docker:
      dockerfile: Dockerfile
  - image: opennms/operator
    context: operator
    docker:
      dockerfile: Dockerfile
    hooks:
      before:
        - command: [ "make", "copy-charts" ]
          dir: operator

portForward:
  - resourceType: deployment
    resourceName: opennms-rest-server
    namespace: skaffold-instance
    port: 9090 # HTTP
  - resourceType: deployment
    resourceName: opennms-notification
    namespace: skaffold-instance
    port: 8080 # HTTP
    localPort: 38080
  - resourceType: deployment
    resourceName: opennms-notification
    namespace: skaffold-instance
    port: 5005 # Debug
    localPort: 5007
  - resourceType: deployment
    resourceName: opennms-rest-server
    namespace: skaffold-instance
    port: 5005 # Debug
    localPort: 5006
  - resourceType: deployment
    resourceName: opennms-core
    namespace: skaffold-instance
    port: 8181 # HTTP
    localPort: 18181
  - resourceType: deployment
    resourceName: opennms-core
    namespace: skaffold-instance
    port: 8101 # SSH
    localPort: 18101
  - resourceType: deployment
    resourceName: opennms-core
    namespace: skaffold-instance
    port: 5005 # Debug
    localPort: 5005
  - resourceType: statefulset
    resourceName: onms-keycloak
    namespace: skaffold-instance
    port: 8080 # HTTP
    localPort: 28080
  - resourceType: deployment
    resourceName: opennms-minion
    namespace: skaffold-instance
    port: 8201 # SSH
    localPort: 38101
  - resourceType: deployment
    resourceName: mail-server
    namespace: skaffold-instance
    port: 8025 # HTTP
    localPort: 8025
  - resourceType: deployment
    resourceName: mail-server
    namespace: skaffold-instance
    port: 1025 # SMTP
    localPort: 1025
  - resourceType: deployment
    resourceName: postgres
    namespace: skaffold-instance
    port: 5432 # Postgres
    localPort: 5432
  - resourceType: deployment
    resourceName: prometheus
    namespace: skaffold-instance
    port: 9090 # prometheus tcp
    localPort: 59090
  - resourceType: deployment
    resourceName: prometheus-pushgateway
    namespace: skaffold-instance
    port: 9091 #prometheus-pushgateway tcp
    localPort: 59091
  - resourceType: deployment
    resourceName: grafana
    namespace: skaffold-instance
    port: 3000 #grafana HTTP
    localPort: 53000
  - resourceType: pod
    resourceName: opennms-kafka-0
    namespace: skaffold-instance
    port: 59092 # kafka tcp local client port
    localPort: 59092 # default port for kafka broker
deploy:
  kubectl:
    manifests:
      - operator/local-instance.yaml
  helm:
    releases:
      - name: opennms-operator
        namespace: opennms
        createNamespace: true
        chartPath: charts/opennms-operator
        valuesFiles:
          - operator/values.yaml
        setValues:
          TLS.SelfSigned: true
        artifactOverrides:
          Operator.image: opennms/operator
          Keycloak.image: opennms/horizon-stream-keycloak-dev
          Grafana.image: opennms/grafana-dev
resourceSelector:
  allow:
    - groupKind: "OpenNMS.k8s.opennms.com"
      image: [ ".*" ]
      labels: [ ".*" ]

---

apiVersion: skaffold/v2beta28
kind: Config
metadata:
  name: operator-dependencies
#deploy:
#  helm:
#    releases:
#      - name: opennms-operator-dependencies
#        chartPath: charts/opennms-operator-dependencies
#        wait: true
